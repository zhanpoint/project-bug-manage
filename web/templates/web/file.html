{% extends 'templates/base/manage_center.html' %}
{% load static %}
{% block css %}
    <link rel="stylesheet" href="{% static 'web/css/file.css' %}"/>
{% endblock %}
{% block content %}
    <div class="container-fluid">
        <div class="panel panel-warning" style="margin-top: 25px">
            <div class="panel-heading">
                <!-- 添加导航路径 -->
                <div class="breadcrumb file-header-left" style="margin: 0; padding: 0; background-color: transparent;">
                    <a href="{% url 'web:file' project_id=request.bugtracer.project.id %}" class="btn btn-link">
                        <i class="fa fa-home" aria-hidden="true"></i> 根目录
                    </a>
                    {% for item in breadcrumb_list %}
                        <a href="{% url 'web:file' project_id=request.bugtracer.project.id %}?folder_id={{ item.id }}"
                           class="btn btn-link">
                            <i class="fa fa-caret-right"></i> {{ item.name }}
                        </a>
                    {% endfor %}
                </div>

                <div class="file-header-right">
                    <div class="btn-group">
                        <!-- 上传文件按钮 -->
                        <!-- 隐藏原生的文件输入框 -->
                        <input type="file" name="uploadFile" id="uploadFile" style="display: none;" multiple/>
                        <!-- 创建一个美化的按钮,这样用户看到的是美化的按钮，但实际操作的是原生的文件选择框 -->
                        <button class="btn btn-primary" onclick="document.getElementById('uploadFile').click()">
                            <i class="fa fa-upload"></i> 上传文件
                        </button>
                        <!-- 新建文件夹按钮 -->
                        <a type="button" data-toggle="modal" data-target="#add_edit_modal" data-whatever="新建文件夹"
                           data-parent_id="{{ request.GET.folder_id }}" class="btn btn-success">
                            <i class="fa fa-plus-circle"></i>新建文件夹
                        </a>
                    </div>
                </div>
            </div>
            <table class="table">
                <thead>
                <tr>
                    <th>名称</th>
                    <th>类型</th>
                    <th>大小</th>
                    <th>修改日期</th>
                    <th>操作</th>
                </tr>
                </thead>
                <tbody>
                {% for item in file_list %}
                    <tr>
                        <td>
                            {% if item.file_type == 1 %}
                                <i class="fa fa-file" style="background-color: #AEAEAE"></i>
                                {{ item.name }}
                            {% else %}
                                <a href="{% url 'web:file' project_id=request.bugtracer.project.id %}?folder_id={{ item.id }}">
                                    <i class="fa fa-folder" style="color: #b58900"></i>
                                    {{ item.name }}
                                </a>

                            {% endif %}

                        </td>
                        <td>
                            {% if item.file_type == 1 %}
                                {{ item.file_extension }}
                            {% else %}
                                文件夹
                            {% endif %}
                        </td>
                        <td>
                            {% if item.file_type == 1 %}
                                {{ item.file_size }}
                            {% else %}

                            {% endif %}
                        </td>
                        <td>{{ item.update_datetime }}</td>
                        <td>
                            <a class="btn btn-primary btn-xs"
                               data-toggle="modal"
                               data-target="#add_edit_modal"
                               data-whatever="编辑文件夹"
                               data-folder-id="{{ item.id }}"
                               data-folder-name="{{ item.name }}">
                                <i class="fa fa-edit"></i>编辑
                            </a>
                            <!--HTML中，id必须是唯一的,由于该a标签是循环生成的，因此不能设置id值 -->
                            <a class="btn btn-danger btn-xs delete_btn"
                               data-toggle="modal"
                               data-target="#deleteModal"
                               data-id="{{ item.id }}"
                               data-name="{{ item.name }}">
                                <i class="fa fa-trash"></i>删除
                            </a>
                        </td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="modal fade" id="add_edit_modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel"></h4>
                </div>
                <div class="modal-body">
                    <form>
                        {% csrf_token %}
                        <!-- 在编辑文件夹时，我们会把当前文件夹的 ID 存储在隐藏表单中， -->
                        <!-- name属性通常是在服务器端通过 request.POST.get('folderId') 获取值时使用的键名
                        如果使用 AJAX 手动构建数据发送（而不是表单自动提交），确实可以省略 name 属性-->
                        {#                       <input type="hidden" id="folderId" name="folderId">#}
                        <input type="hidden" id="folderId">
                        <!--添加隐藏的父文件夹ID字段-->
                        <input type="hidden" id="parentId">
                        {% for field in form %}
                            <div class="form-group">
                                <label for="{{ field.id_for_label }}">{{ field.label }}</label>
                                {{ field }}
                                <span class="error-msg"></span>
                            </div>
                        {% endfor %}
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="submit_btn">确定</button>
                </div>
            </div>
        </div>
    </div>
    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteModal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal">
                        <span>&times;</span>
                    </button>
                    <h4 class="modal-title">
                        <i class="fa fa-exclamation-triangle text-warning"></i>
                        提示
                    </h4>
                </div>
                <div class="modal-body">
                    <div>
                        确定要删除文件夹 "<span id="folderToDelete"></span>" 吗？
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">
                        <i class="fa fa-trash"></i> 确定删除
                    </button>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block js %}
    <script src="https://gosspublic.alicdn.com/aliyun-oss-sdk-6.17.1.min.js"></script>
    <script>
        const file_add_url = "{% url 'web:file_add' project_id=request.bugtracer.project.id %}";
        const file_edit_url = "{% url 'web:file_edit' project_id=request.bugtracer.project.id %}";
        const file_delete_url = "{% url 'web:file_delete' project_id=request.bugtracer.project.id %}";
        $(function () {
            initmodal();  // 根据触发按钮改变模态内容
            bindAddEditFolder();  // 绑定新建添加文件夹事件
            bindDeleteFolder();  // 绑定删除文件夹事件
        })

        function initmodal() {
            // 监听ID为'add_edit_modal'的模态框的显示事件
            $('#add_edit_modal').on('show.bs.modal', function (event) {
                // 获取当前模态框的jQuery对象
                let modal = $(this)
                // 获取触发模态框的元素（通常是按钮）
                let button = $(event.relatedTarget)

                // 获取数据（当前点击按钮所操作文件夹的数据）
                let recipient = button.data('whatever')
                let folderId = button.data('folder-id');  // 编辑的文件夹ID
                let folderName = button.data('folder-name');  // 编辑的文件夹名称
                let parentId = button.data('parent_id')  // 新建时的父文件夹ID

                // 设置模态框标题
                modal.find('.modal-title').text(recipient)
                // 重置表单（获取jQuery对象（所有的form元素）中的第一个原生DOM元素）
                modal.find('form')[0].reset();
                // 清除错误信息
                modal.find('.error-msg').text('');

                if (folderId) {  // 编辑模式
                    modal.find('#folderId').val(folderId);  // 将ID存储在隐藏字段中
                    modal.find('#id_name').val(folderName);  // 设置name字段输入框的值为当前文件夹的名称
                } else {  // 新建模式
                    modal.find('#folderId').val('');
                    modal.find('#id_name').val('');
                    // 保存父文件夹ID
                    modal.find('#parentId').val(parentId)
                }

            })
        }

        function bindAddEditFolder() {
            $('#submit_btn').click(function () {
                let folderId = $('#folderId').val() || ''; // 获取在隐藏字段中的ID
                let url = folderId ? file_edit_url : file_add_url;  // 当前请求地址
                let method = folderId ? 'PUT' : 'POST';  // 编辑模式：PUT，新增模式：POST

                // 根据请求类型决定如何处理数据
                let ajaxOptions = {
                    url: url,
                    type: method,
                    headers: {
                        // 添加 CSRF 令牌
                        "X-CSRFToken": $('[name="csrfmiddlewaretoken"]').val()
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.status) {
                            $('#add_edit_modal').modal('hide');
                            window.location.reload();
                        } else {
                            $.each(data.error, function (key, value) {
                                $("#id_" + key).next().text(value[0]);
                            })
                        }
                    }
                };

                if (method === 'PUT') {
                    // PUT 请求时构造 JSON 数据
                    ajaxOptions.headers["Content-Type"] = "application/json";  // 设置请求体中的数据格式为JSON
                    ajaxOptions.data = JSON.stringify({  // 将数据转换为JSON字符串
                        'folderId': folderId,
                        'name': $('#id_name').val() || ''
                    });
                } else {
                    // POST 请求时使用表单数据
                    let formData = new FormData();  // 创建 FormData 对象
                    formData.append('name', $('#id_name').val() || '');  // 将表单中的name字段值添加到FormData对象中
                    formData.append('parent', $('#parentId').val() || '');  // 将父文件夹ID添加到FormData对象中
                    ajaxOptions.data = formData;  // 配置ajaxOptions，设置data为FormData对象
                    // POST 请求不需要设置 Content-Type，让浏览器自动处理数据格式
                    ajaxOptions.processData = false;
                    ajaxOptions.contentType = false;
                }
                $.ajax(ajaxOptions);
            })
        }

        function bindDeleteFolder() {
            let deleteId = null;

            // 点击删除按钮
            $('.delete_btn').click(function () {
                deleteId = $(this).data('id');  // 获取当前删除的文件夹ID
                // 添加前端验证(提供更好的用户体验，并减少无效请求发送到服务器)
                if (!deleteId) {
                    showMessageDelete('error', '无效的文件/文件夹ID');
                    return;
                }
                $('#folderToDelete').text($(this).data('name'));  // 设置要删除的文件夹名称
                // 移除了重复的 modal('show') 调用，因为 Bootstrap 的 data-toggle="modal" 已经会处理模态框的显示
                // $('#deleteModal').modal('show');
            });

            // 确认删除
            $('#confirmDelete').click(function () {
                // $btn 是一个 jQuery 对象，它引用了当前被选中的按钮元素
                // 禁用当前按钮，并将按钮文本更改为带有旋转图标的“删除中...”
                let $btn = $(this).prop('disabled', true)
                    .html('<i class="fa fa-spinner fa-spin"></i> 删除中...');

                $.ajax({
                    url: file_delete_url,
                    type: 'POST',
                    data: {
                        'folderId': deleteId,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    success: function (res) {
                        if (res.status) {
                            $('#deleteModal').modal('hide');
                            showMessageDelete('success', '删除成功');
                            // 让用户能看到"删除成功"的提示消息（如果立即刷新页面，提示消息可能还没来得及看到就消失了）
                            setTimeout(() => window.location.reload(), 1500);
                        } else {
                            showMessageDelete('error', res.error || '删除失败');
                            $btn.prop('disabled', false)
                                .html('<i class="fa fa-trash"></i> 确定删除');
                        }
                    }
                });
            });
        }

        // 删除消息提示
        function showMessageDelete(type, msg) {
            // 1. 根据type参数决定使用哪个图标和样式类
            let icon = type === 'success' ? 'check-circle' : 'times-circle';  // 设置图标(对钩：叉号)
            let alertClass = type === 'success' ? 'success' : 'danger';  // 设置样式（红色：绿色）
            // left: 50% - 将元素的左侧定位到视窗宽度的50%处
            // transform: translateX(-50%) - 只在X轴（水平方向）上向左移动自身宽度的50%
            // .appendTo('body')：将消息框添加到页面
            // .delay(1500)：停留1.5秒
            // .fadeOut()：使用淡出动画效果
            // .remove()：动画完成后删除元素
            $(`<div class="alert alert-${alertClass}" style="position: fixed; top: 30px; left: 50%;
transform: translateX(-50%); text-align: center; z-index: 9999;">
<i class="fa fa-${icon}"></i> ${msg}
</div>`).appendTo('body').delay(1500).fadeOut(function () {
                $(this).remove();
            });
        }

        // 文件上传处理
        $('#uploadFile').change(async function (e) {  // 当用户选择文件时，触发文件输入框的 change 事件,执行异步函数处理文件上传逻辑
            const file = e.target.files[0];  // 获取选择的第一个文件
            if (!file) return;  // 如果没有选择文件，直接返回

            try {
                // 显示上传进度提示
                showMessageUpload('info', '文件上传中...');

                // 向后端请求阿里云OSS的临时访问凭证
                /*
                    await fetch(url, options) 发起一个到指定 URL 的 HTTP 请求。
                    await 关键字确保代码会等待 fetch 请求完成并返回响应，然后再继续执行后续代码。
                    fetch 返回一个 Promise，await 会暂停当前函数的执行，直到 Promise 被解决（resolve）或拒绝（reject），从而获取到最终的响应结果
                */
                const res = await fetch(`{% url 'web:file_credentials' project_id=request.bugtracer.project.id %}`);
                // 解构响应数据获取状态、凭证数据和错误信息
                const {status, data, error} = await res.json();

                // 如果临时凭证获取失败，显示错误消息并返回
                if (!status) {
                    showMessageUpload('error', error || '获取上传凭证失败');
                    return;
                }

                // 初始化OSS客户端
                const client = new OSS({
                    ...data,  // 展开data对象，包含accessKeyId、accessKeySecret等凭证信息
                    secure: true  // 使用HTTPS协议
                });

                // 生成文件路径
                const folder_id = new URLSearchParams(window.location.search).get('folder_id') || '';  // 从URL参数中获取当前文件夹ID
                const key = `${file.name}`;  // 生成OSS中的文件存储路径

                // 上传文件
                await client.multipartUpload(key, file, {  //
                    progress: p => showProgress(Math.floor(p * 100))  // 回调函数 progress，将上传进度转换为百分比并调用 showProgress 显示
                });

                // 保存文件信息
                const formData = new FormData();  // 创建FormData对象存储文件信息
                formData.append('name', file.name);  // 使用append方法添加键值对，每个键对应一个表单字段名,值可以是字符串或 Blob 类型（如文件）
                formData.append('key', key);
                formData.append('size', file.size);
                formData.append('type', file.type);
                formData.append('parent', folder_id);
                // 发送POST请求到后端保存文件记录
                const saveRes = await fetch("{% url 'web:file_upload' project_id=request.bugtracer.project.id %}", {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value  // CSRF令牌确保安全
                    },
                    body: formData
                });

                const saveResult = await saveRes.json();
                if (!saveResult.status) {
                    showMessageUpload('error', saveResult.error || '保存文件信息失败');
                    return;
                }

                showMessageUpload('success', '上传成功');
                setTimeout(() => window.location.reload(), 1000);

            } catch (err) {
                showMessageUpload('error', err.message || '上传失败');
            }
        });

        // 显示上传进度
        function showProgress(percentage) {
            // 更新或创建进度提示
            showMessageUpload('info', `上传进度: ${percentage}%`);
        }

        // 优化消息提示函数
        function showMessageUpload(type, msg) {
            // 移除已存在的提示
            $('.alert-message').remove();

            // 配置提示样式
            const config = {
                success: {icon: 'check-circle', class: 'success'},
                error: {icon: 'times-circle', class: 'danger'},
                info: {icon: 'info-circle', class: 'info'}
            }[type] || {icon: 'info-circle', class: 'info'};

            // 创建提示元素
            const alert = $(`
                <div class="alert alert-${config.class} alert-message"
                     style="position: fixed; top: 30px; left: 50%; transform: translateX(-50%);
                            z-index: 9999; padding: 10px 20px; border-radius: 4px;">
                    <i class="fa fa-${config.icon}"></i> ${msg}
                </div>
            `).appendTo('body');

            // 如果是成功或错误提示，自动消失
            if (type !== 'info') {
                alert.delay(1500).fadeOut(() => alert.remove());
            }
        }
    </script>
{% endblock %}